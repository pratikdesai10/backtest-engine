//@version=5
strategy("EMA Breakout + Trailing Exit", overlay=true, process_orders_on_close=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ==========================================
// 1. INPUT PARAMETERS
// ==========================================
grp_ema = "EMA Settings"
emaFastLen = input.int(10, "Fast EMA Length", group=grp_ema)
emaSlowLen = input.int(20, "Slow EMA Length", group=grp_ema)

grp_bo = "Range Breakout"
lookback = input.int(10, "Range Lookback (candles)", minval=3, maxval=20, group=grp_bo, tooltip="Number of previous candles to define the consolidation range. Optimized: 10")

grp_exit = "Exit Method"
exitMode = input.string("EMA Cross", "Exit Mode", options=["EMA Cross", "Fixed RR"], group=grp_exit, tooltip="EMA Cross: exit when 10 EMA crosses below 20 EMA (PF=2.22). Fixed RR: exit at fixed risk-reward target (PF=1.96).")
rrRatio  = input.float(3.0, "Fixed RR Ratio (only if Fixed RR)", step=0.5, minval=1.0, group=grp_exit)

// ==========================================
// 2. INDICATOR CALCULATIONS
// ==========================================
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)

rangeHigh = ta.highest(high[1], lookback)
rangeLow  = ta.lowest(low[1], lookback)

// ==========================================
// 3. SIGNAL DETECTION
// ==========================================
crossUp   = ta.crossover(emaFast, emaSlow)
crossDown = ta.crossunder(emaFast, emaSlow)
breakout  = close > rangeHigh

longCondition = crossUp and breakout

// ==========================================
// 4. STRATEGY EXECUTION
// ==========================================
var float entryPrice = na
var float slPrice    = na
var float tpPrice    = na
var bool  wasInTrade = false

// ── Entry ──
if longCondition and strategy.position_size == 0
    entryPrice := close
    slPrice    := rangeLow
    float risk  = close - rangeLow
    tpPrice    := exitMode == "Fixed RR" ? close + risk * rrRatio : na
    strategy.entry("Long", strategy.long, comment="Breakout")

// ── Exit ──
if strategy.position_size > 0
    if exitMode == "Fixed RR"
        strategy.exit("Exit", "Long", stop=slPrice, limit=tpPrice, comment_loss="SL", comment_profit="TP")
    else
        // EMA Cross mode: SL via stop order, trend exit via close
        strategy.exit("SL Exit", "Long", stop=slPrice, comment_loss="SL")
        if crossDown
            strategy.close("Long", comment="EMA Cross Exit")
    wasInTrade := true
else if wasInTrade
    entryPrice := na
    slPrice    := na
    tpPrice    := na
    wasInTrade := false

// ==========================================
// 5. VISUALIZATION
// ==========================================
p1 = plot(emaFast, "10 EMA", color=color.new(color.blue, 0), linewidth=2)
p2 = plot(emaSlow, "20 EMA", color=color.new(color.orange, 0), linewidth=2)
fill(p1, p2, color=emaFast > emaSlow ? color.new(color.green, 90) : color.new(color.red, 90), title="Trend Fill")

plot(rangeHigh, "Range High", color=color.new(color.teal, 50), style=plot.style_stepline, linewidth=1)
plot(rangeLow,  "Range Low",  color=color.new(color.maroon, 50), style=plot.style_stepline, linewidth=1)

// BUY signal
plotshape(longCondition and strategy.position_size == 0, title="Buy", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="BUY")

// SELL signal (EMA cross exit)
plotshape(strategy.position_size > 0 and crossDown and exitMode == "EMA Cross", title="Sell", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, text="SELL")

// SL / TP / Entry lines
plot(strategy.position_size > 0 ? slPrice    : na, "Stop Loss",   color=color.red,   style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 and exitMode == "Fixed RR" ? tpPrice : na, "Take Profit", color=color.green, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size > 0 ? entryPrice : na, "Entry",       color=color.gray,   style=plot.style_linebr, linewidth=1)

// ==========================================
// 6. INFO TABLE
// ==========================================
var table t = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80), border_width=1)
if barstate.islast
    table.cell(t, 0, 0, "Param",     text_color=color.white, text_size=size.small)
    table.cell(t, 1, 0, "Value",     text_color=color.white, text_size=size.small)
    table.cell(t, 0, 1, "Exit Mode", text_color=color.gray,  text_size=size.small)
    table.cell(t, 1, 1, exitMode,    text_color=color.green,  text_size=size.small)
    table.cell(t, 0, 2, "Lookback",  text_color=color.gray,  text_size=size.small)
    table.cell(t, 1, 2, str.tostring(lookback) + " bars", text_color=color.green, text_size=size.small)
    table.cell(t, 0, 3, "Range High",text_color=color.gray,  text_size=size.small)
    table.cell(t, 1, 3, str.tostring(rangeHigh, "#.##"), text_color=color.teal, text_size=size.small)
    table.cell(t, 0, 4, "Range Low", text_color=color.gray,  text_size=size.small)
    table.cell(t, 1, 4, str.tostring(rangeLow, "#.##"),  text_color=color.maroon, text_size=size.small)
